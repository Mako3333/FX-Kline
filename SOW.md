# **SOW: L2 テクニカル分析指標 拡張実装仕様（最新版）**

## **1. 目的**

L2レイヤー（サマリー分析レポート）の品質向上を目的とし、
サポート・レジスタンス、MA構造、トレンド構造をより正確に、
HITL（人間承認型AIトレード）利用に耐える情報量へ拡張する。

最上位の目的は以下の2点。

1. **波構造（スイング）の適切な検出精度の担保**
2. **LLMが戦略コメントを生成するために必要な"圧縮された相場文脈情報"の拡充**

---

# **2. サポート・レジスタンス検出ロジック拡張**

## **2.1 基本方針**

* 時間足ごとのサポレジ検出対象本数
  * **1時間足**: 過去 **120本**（約5営業日）
  * **4時間足**: 過去 **60本**（約2週間）
  * **日足**: 過去 **60本**（約3ヶ月）
* **ATR（Average True Range）の定義**
  * 全時間足において **period=14** を使用
  * ATR = 直近14本のローソク足における True Range の単純移動平均
  * True Range = max(|高値-安値|, |高値-前日終値|, |安値-前日終値|)
  * 時間足ごとの意味:
    * **ATR_1h**: 直近14時間の平均ボラティリティ
    * **ATR_4h**: 直近56時間（約2.3日）の平均ボラティリティ
    * **ATR_1d**: 直近14営業日の平均ボラティリティ
* ATR は **日足サポレジに対するガードレール**としてのみ使用する
  → 1時間足 / 4時間足は「期間（本数）＋レベルマージ」で制御し、ATR×5 フィルタは適用しない
* フォールバックロジック、候補抽出ロジック（反転検出・週ブレイク判定など）は既存仕様をベースとし、
  その後段にフィルタ／マージ処理のみ追加する。

---

## **2.2 日足 ATR ガードレール**

### **仕様**

**日足**で候補として抽出されたサポート・レジスタンスレベル `L` について、
最新終値 `C` との距離が **日足 ATR×5** を超える場合、その候補を除外する。

### **式**

```
valid_daily = abs(L - C) <= ATR_1d * 5
```

### **目的**

* 過去60本に基づき「日足の波・スイング構造」を正しく検出する
* ただし、現在価格から見て遠すぎる“今回の相場では出番がない日足ライン”を排除する
* ゴールド / ドル円など銘柄ごとのボラティリティ差を、ATR スケールで自然に吸収する

---

## **2.3 フィルタ／マージ適用位置**

* **1時間足** `_compute_intraday_reversals`
  * 日次ごとの高値／安値から反転候補を抽出したあと、
    **ATR\_1h を用いた近接レベルマージ**を最後に適用する。
* **4時間足** `_compute_four_hour_levels`
  * 週ブレイクロジックで先週・先々週の high / low 候補を出したあと、
    **ATR\_4h を用いた近接レベルマージ**を最後に適用する。
* **日足** `_compute_daily_reversals`
  * 三本足の反転パターンで候補を抽出したあと、
    **日足 ATR×5 ガードレール**を最後に適用する。

いずれのロジックでも、マージ／フィルタ適用後に候補が0本の場合のみ、
既存のフォールバック（単純極値抽出など）を許可する。

なお、従来の日足ロジックに存在した「現在値から±0.5%以内」という近接制約は撤廃し、
距離制御は ATR×5 ガードレールのみに一本化する。

---

## **2.4 時間足別サポレジ検出ロジック（概要）**

### **2.4.1 1時間足（Intraday）**

* **対象期間**
  * 過去 120 本（約 5 営業日）の 1 時間足
* **候補抽出ロジック**
  * バーを日付ごとにグルーピングし、その日の高値 / 安値を抽出する。
  * 高値について:
    * その後 5 本（5 時間）で高値が更新されなければ「レジスタンス候補」とみなす。
  * 安値について:
    * その後 5 本で安値が更新されなければ「サポート候補」とみなす。
* **近接レベルマージ**
  * サポート同士／レジスタンス同士で
    `abs(L_i - L_j) < ATR_1h` のものは同一ゾーンとみなし、代表レベル1本に統合する。
  * **代表レベル選定基準**（優先順位順）:
    1. **ヒゲの深さ**（=反転強度）を優先 → 高値/安値がより極端なものを採用
    2. 同程度なら**新しい方**を採用
  * マージ後にレベル本数が要求本数（例: 2本）より少なくなった場合、
    もともとの候補群の中から「既存レベルと ATR_1h 以上離れている」価格を
    追加選出し、可能な範囲で最大本数まで埋め直す（マージ＋補充）。
  * これにより、1時間足で 20〜30pips 程度しか離れていない「ほぼ同じサポートが2本」
    といった冗長な出力を防ぐ。

### **2.4.2 4時間足（Swing / 週ブレイクベース）**

* **対象期間**
  * 過去 60 本（約 2 週間）の 4 時間足
* **候補抽出ロジック（週ブレイクをベースに、2週に絞る）**
  * 4時間足を週単位（例: `W-SUN`）でグルーピングし、
    直近 2 週間（先週・先々週）の `week_high` / `week_low` を計算する。
  * 週ブレイク判定:
    * `last_week_high > prev_week_high` → 上方向ブレイクアウト
    * `last_week_low < prev_week_low` → 下方向ブレイクダウン
  * ブレイクが発生している場合:
    * 先週・先々週の `week_high` / `week_low` をサポレジ候補とする。
    * それ以前の週は候補に含めない（**時間足サポレジ検出は「2週に絞る」**）。
* **フォールバック**
  * ブレイクが発生しない場合は、過去 60 本のシンプルな極値（最安値・最高値）から
    サポート / レジスタンス候補を作る。
* **近接レベルマージ**
  * サポート同士／レジスタンス同士で `abs(L_i - L_j) < ATR_4h` のものは同一ゾーンとして統合する。
  * 4時間足では構造優先のため、マージによってレベル本数が減少しても
    追加の埋め直しは行わず、その時点での代表レベルのみを返す（マージのみ）。
  * 既存の「5pips マージ」は廃止し、各銘柄のボラティリティに応じてスケールする
    ATR ベースのマージに置き換える。

### **2.4.3 日足（Position / マクロ構造）**

* **対象期間**
  * 過去 60 本（約 3ヶ月）の日足
* **候補抽出ロジック（三本足反転パターン）**
  * 各足 `i` について、次の 3 本 `i+1, i+2, i+3` を用いた反転パターンを検出する。
  * この際、従来の「現在値から±0.5%以内」という近接条件は用いない。

#### **レジスタンス候補の検出（高値 + 3本連続陰線）**

```
足の並び:
[i][i+1][i+2][i+3]
 ↑   ↑    ↑    ↑
 │   └────┴────┴── 3本連続で「終値 < 始値」（陰線）
 │
 └── この足の「高値」がレジスタンス候補

判定条件:
  1. i+1, i+2, i+3 すべてが陰線（close < open）
  2. 上記を満たせば、足 i の high をレジスタンス候補として登録

意味:
  「ある日の高値をつけた後、3日連続で売りが優勢だった」
  → その高値は"天井"として意識されている可能性が高い
```

#### **サポート候補の検出（安値 + 3本連続陽線）**

```
足の並び:
[i][i+1][i+2][i+3]
 ↑   ↑    ↑    ↑
 │   └────┴────┴── 3本連続で「終値 > 始値」（陽線）
 │
 └── この足の「安値」がサポート候補

判定条件:
  1. i+1, i+2, i+3 すべてが陽線（close > open）
  2. 上記を満たせば、足 i の low をサポート候補として登録

意味:
  「ある日の安値をつけた後、3日連続で買いが優勢だった」
  → その安値は"底"として意識されている可能性が高い
```

* **ATR ガードレール**
  * 抽出した候補レベルのうち、`abs(L - C) > ATR_1d * 5` を満たすものは除外する。
  * これにより、「現在の相場から見て遠すぎる日足ライン」を自然に削る。

---

# **3. SMA/EMA 拡張仕様**

L2 出力に、以下のMA指標を追加する。

---

## **3.1 SMA（ストーリー抽出に利用する）**

### **3.1.1 SMA 対象**

* SMA5
* SMA13
* SMA21

### **3.1.2 SMA で出す値**

1. **最新の値**

   ```
   sma_5_latest
   sma_13_latest
   sma_21_latest
   ```

2. **傾き（slope）※分類形式**

   * 過去10本の SMA 値に対して線形回帰し、傾きの符号・強さを判定する
   * 返すのは文字列ラベル

   ```
   "strong_up" | "up" | "flat" | "down" | "strong_down"
   ```

   * **分類閾値**（線形回帰の傾き係数に基づく）:

   | ラベル | 条件 |
   |--------|------|
   | `strong_up` | slope > +0.002 |
   | `up` | +0.0005 < slope ≤ +0.002 |
   | `flat` | -0.0005 ≤ slope ≤ +0.0005 |
   | `down` | -0.002 ≤ slope < -0.0005 |
   | `strong_down` | slope < -0.002 |

3. **並び順（POG2整合確認用）**

   * SMA5 > SMA13 > SMA21 の場合 `"bullish"`
   * SMA5 < SMA13 < SMA21 の場合 `"bearish"`
   * 上記以外は `"mixed"`

4. **価格との乖離率（各時間足で計算）**
   * SMA5のみ、全時間足（1h, 4h, 1d）で計算する
   ```
   deviation_sma_5 = (close - sma_5) / sma_5
   ```

---

## **3.2 EMA（反発や支持確認のみ利用する）**

### **3.2.1 EMA 対象**

* EMA25
* EMA75
* EMA90
* EMA200

### **3.2.2 EMA で出す値**

1. **最新の値**

   ```
   ema_25_latest
   ema_75_latest
   ema_90_latest
   ema_200_latest
   ```

2. **“反発判定”のみ行う**



---

## **4. MA から派生した特徴量の理由**

あなたの意図を整理し、仕様に反映している。

### ■ SMA →「ストーリー」「構造」を見るため

* 短期・中期・長期の位置関係
* 傾きの向き（上昇か下降か）
* 価格がどれだけ離れているか
  これにより LLM が「流れ・圧力・勢い」を理解できる。

### ■ EMA →「反発点」を見るため

* EMAはトレンド波形の“床”や“天井”になりやすい
* 傾きやクロスではなく「タッチしたかどうか」が本質
* オシレーターに近い扱いで、精度の高い判断材料になる

---

# **5. 不要事項（今回は明確に除外）**

* MA の生時系列 arrays
* クロス検知（ゴールデン/デッドクロス）
* 全時間足での slope 計算
* POG2自動判定
* 構造の自動ラベリング（これは後フェーズ）

---

# **6. L2 JSON 拡張例（最終形）**

各時間足（1h, 4h, 1d）ごとに以下の構造で出力する。

## **6.1 日足（1d）の例**

```json
{
  "pair": "USDJPY",
  "timeframe": "1d",
  "support_levels": [152.827, 151.500],
  "resistance_levels": [157.887, 157.527],
  "atr": 1.21,

  "sma": {
    "5": {
      "latest": 156.10,
      "slope": "up",
      "deviation": 0.0041
    },
    "13": {
      "latest": 155.21,
      "slope": "up"
    },
    "21": {
      "latest": 154.82,
      "slope": "flat"
    },
    "ordering": "bullish"
  },

  "ema": {
    "25": {
      "latest": 155.40,
      "reaction": "support_bounce",
      "reaction_bars_ago": 5
    },
    "75": {
      "latest": 153.20,
      "reaction": "none",
      "reaction_bars_ago": null
    },
    "90": {
      "latest": 152.90,
      "reaction": "resistance_reject",
      "reaction_bars_ago": 38
    },
    "200": {
      "latest": 151.50,
      "reaction": "none",
      "reaction_bars_ago": null
    }
  }
}
```

## **6.2 4時間足（4h）の例**

```json
{
  "pair": "USDJPY",
  "timeframe": "4h",
  "support_levels": [152.814, 153.004],
  "resistance_levels": [157.892, 157.782],
  "atr": 0.4329,

  "sma": {
    "5": {
      "latest": 156.05,
      "slope": "up",
      "deviation": 0.0038
    },
    "13": {
      "latest": 155.18,
      "slope": "up"
    },
    "21": {
      "latest": 154.75,
      "slope": "flat"
    },
    "ordering": "bullish"
  },

  "ema": {
    "25": {
      "latest": 155.35,
      "reaction": "support_bounce",
      "reaction_bars_ago": 12
    },
    "75": {
      "latest": 153.15,
      "reaction": "none",
      "reaction_bars_ago": null
    },
    "90": {
      "latest": 152.85,
      "reaction": "none",
      "reaction_bars_ago": null
    },
    "200": {
      "latest": 151.40,
      "reaction": "none",
      "reaction_bars_ago": null
    }
  }
}
```

## **6.3 1時間足（1h）の例**

```json
{
  "pair": "USDJPY",
  "timeframe": "1h",
  "support_levels": [154.809, 155.047],
  "resistance_levels": [157.193, 156.759],
  "atr": 0.2721,

  "sma": {
    "5": {
      "latest": 156.00,
      "slope": "up",
      "deviation": 0.0025
    },
    "13": {
      "latest": 155.15,
      "slope": "up"
    },
    "21": {
      "latest": 154.70,
      "slope": "flat"
    },
    "ordering": "bullish"
  },

  "ema": {
    "25": {
      "latest": 155.30,
      "reaction": "support_bounce",
      "reaction_bars_ago": 8
    },
    "75": {
      "latest": 153.10,
      "reaction": "none",
      "reaction_bars_ago": null
    },
    "90": {
      "latest": 152.80,
      "reaction": "none",
      "reaction_bars_ago": null
    },
    "200": {
      "latest": 151.35,
      "reaction": "none",
      "reaction_bars_ago": null
    }
  }
}
```

**注意**: 各時間足で `sma.5.deviation` は必ず計算・出力する。これにより LLM は各時間足での価格とSMA5の乖離を把握できる。

---

# **7. 本 SOW の最終目的**

* L2出力だけでLLMが「今日の地合い」を文章化できる
* POG2の階層・整合性を的確に判断できる
* サポレジの精度が高まり、HITL承認フローの信頼度が上がる
* 将来「トレード計画生成AI」の基盤として利用可能になる


## EMA反応検知ロジック 最終版（SOW用）

### 0. 対象とする時間足・期間

EMA まわりでは、**「計算に使うデータ期間」と「反応を検出するウィンドウ」を明確に分離**する。

1. **オシレーター計算用のデータ期間（EMA / RSI / ATR など）**
   * 日足レポート: `period=200d` → **200本**の 1d 足をすべて使って計算する
   * 4時間足レポート: `period=35d` → **約210本**の 4h 足をすべて使って計算する
   * 1時間足レポート: `period=10d` → **240本**の 1h 足をすべて使って計算する
   → EMA200 を含む、すべてのオシレーター値は「このフル期間」を母集団として計算する。

2. **EMA反応検出ウィンドウ（どこまでの過去を"効いているか"として見るか）**
   * 日足: フル期間 200 本のうち、直近 **60本**を走査対象とする
   * 4時間足: フル期間 210 本のうち、直近 **60本**を走査対象とする
   * 1時間足: フル期間 240 本のうち、直近 **120本**を走査対象とする
   → サポレジ判定や EMA 反応検出は、この「末尾側の一部ウィンドウ」に対してのみ行う。
   → **オシレーター計算の母数に、サポレジ用の短いウィンドウ本数を流用しないこと。**

EMA は、既存仕様どおり

* EMA25
* EMA75
* EMA90
* EMA200
  を対象とする。

---

## 1. 検出する反応パターン（2種類・OR条件）

EMA で検出する「反応」は以下の 2 パターン。

1. サポートとしての反発
   → `support_bounce`
2. レジスタンスとしての反発
   → `resistance_reject`

この 2 つのどちらかを満たせば「反応あり」とし、
どちらも満たさなければ「反応なし (`none`)」。

AND ではなく OR でよい。

---

## 2. サポート反発パターン（support_bounce）

足番号 `i` を「反応候補」として評価する。

### 2.1 コア条件（その足単体）

> 最安値は EMA を“割っている”のに、終値は EMA の“上で引けている”足

数式で書くと:

* 条件1: 安値が EMA を下抜ける
  `low_i < ema_i`
* 条件2: 終値が EMA を上回って引ける
  `close_i > ema_i`

これだけで
「下ヒゲで EMA をオーバーシュート → そこから買い戻されて EMA の上で引けた」
という“強いサポート反応候補”とみなす。

### 2.2 確認用の追撃条件（最大2本先まで）

足 `i` を候補とみなしたら、
`i+1`, `i+2` を最大 2 本だけ追加で見る。

目的は:

* EMA を明確に割り込まず踏みとどまっているか
* どこかで EMA から上方向に離れ始めているか

シンプルな判定案:

1. `j ∈ {i, i+1, i+2}` のすべてについて
   `close_j >= ema_j` がほぼ維持されていること
   （途中で EMA 割れがあれば、その候補は無効）

2. `i+2` まで存在する場合は
   `close_{i+2} > close_i` を満たしていれば「上方向に離れ始めた」とみなす

**Fallback 条件（`i+2` が存在しない場合）**:

| ケース | 条件 | 判定 |
|--------|------|------|
| `i` が最新足（`i+1`, `i+2` なし） | コア条件のみで判定 | 追撃条件スキップ、`reaction_bars_ago = 0` |
| `i` が1本前（`i+1` のみ存在） | `close_{i+1} > close_i` | 上方向に離れ始めたと判定 |
| `i` が2本以上前（通常ケース） | `close_{i+2} > close_i` | 通常判定 |

この 2 段階を満たす「最新の i」を
`reaction = "support_bounce"` として採用する。

---

## 3. レジスタンス反発パターン（resistance_reject）

サポートの完全な鏡像（上下反転）として定義する。

### 3.1 コア条件

> 最高値は EMA を“上に抜けた”のに、終値は EMA の“下で引けている”足

* 条件1: 高値が EMA を上抜ける
  `high_i > ema_i`
* 条件2: 終値が EMA を下回って引ける
  `close_i < ema_i`

→ 「上ヒゲで EMA をオーバーシュート → 売り戻されて EMA の下で引けた」
という“強いレジスタンス反応候補”。

### 3.2 追撃条件（最大2本先まで）

`i+1`, `i+2` を最大 2 本見る。

1. `j ∈ {i, i+1, i+2}` のすべてについて
   `close_j <= ema_j` が維持されていること
2. `i+2` が存在する場合、
   `close_{i+2} < close_i` なら「下方向に離れ始めた」とみなす

**Fallback 条件（`i+2` が存在しない場合）**:

| ケース | 条件 | 判定 |
|--------|------|------|
| `i` が最新足（`i+1`, `i+2` なし） | コア条件のみで判定 | 追撃条件スキップ、`reaction_bars_ago = 0` |
| `i` が1本前（`i+1` のみ存在） | `close_{i+1} < close_i` | 下方向に離れ始めたと判定 |
| `i` が2本以上前（通常ケース） | `close_{i+2} < close_i` | 通常判定 |

これを満たす「最新の i」を
`reaction = "resistance_reject"` として採用する。

---

## 4. 判定の優先順位と出力仕様

### 4.1 優先順位

**同一時間足の同一EMAに対して**:

1. 対象期間（60本 / 120本）を後ろから走査し、
   `support_bounce` と `resistance_reject` の両パターンを**独立に検索**する。

2. 両パターンの検出結果を比較し、**直近（`bars_ago` が最小）のパターンを採用**する。

3. どちらも見つからなければ `reaction = "none"`。

**補足**:
* **同じ足の同じEMAで** `support_bounce` と `resistance_reject` が同時に成立することは構造上ありえない
  （終値がEMAの上か下か、どちらか一方のため）
* **期間内で異なる足で**両パターンが見つかることは十分あり得る（例: 5本前にsupport_bounce、10本前にresistance_reject）
  → この場合は、より新しい（`bars_ago` が小さい）方を優先する
* EMAのロールリバーサル（価格がEMAを上下に跨ぐ動き）を考慮し、最新の反応を採用することで、現在の相場状況をより正確に反映する

**判定フロー図**:

```
for ema in [EMA25, EMA75, EMA90, EMA200]:
    support_candidate = null
    resistance_candidate = null
    
    # 検出ウィンドウを後ろから走査（両パターンを独立に検索）
    for i in range(検出ウィンドウ末尾 → 先頭):
        
        # support_bounce チェック（まだ見つかっていない場合のみ）
        if support_candidate is null:
            if low[i] < ema[i] AND close[i] > ema[i]:
                if 追撃条件OK(i, i+1, i+2):
                    support_candidate = { type: "support_bounce", bars_ago: 現在位置 - i }
        
        # resistance_reject チェック（まだ見つかっていない場合のみ）
        if resistance_candidate is null:
            if high[i] > ema[i] AND close[i] < ema[i]:
                if 追撃条件OK(i, i+1, i+2):
                    resistance_candidate = { type: "resistance_reject", bars_ago: 現在位置 - i }
        
        # 両方見つかったら走査終了（後ろから走査しているので、これが最新）
        if support_candidate is not null AND resistance_candidate is not null:
            break
    
    # 両候補を比較して、より新しい（bars_agoが小さい）方を採用
    if support_candidate is not null AND resistance_candidate is not null:
        if support_candidate.bars_ago < resistance_candidate.bars_ago:
            reaction = "support_bounce"
            reaction_bars_ago = support_candidate.bars_ago
        else:
            reaction = "resistance_reject"
            reaction_bars_ago = resistance_candidate.bars_ago
    elif support_candidate is not null:
        reaction = "support_bounce"
        reaction_bars_ago = support_candidate.bars_ago
    elif resistance_candidate is not null:
        reaction = "resistance_reject"
        reaction_bars_ago = resistance_candidate.bars_ago
    else:
        reaction = "none"
        reaction_bars_ago = null
    
    output[ema] = { reaction, reaction_bars_ago }
```

### 4.2 L2 出力仕様

EMA セクションは、各 EMA ごとに以下の3つのフィールドを持つ:

* `latest`: 最新の EMA 値
* `reaction`: `"support_bounce" | "resistance_reject" | "none"`
* `reaction_bars_ago`: その反応が「何本前」に発生したか（見つからない場合は `null`）

**詳細な出力例はセクション6「L2 JSON 拡張例（最終形）」を参照。**

---

## 5. まとめ

* EMAの反応判定ロジックは
  * 「サポート反発 (`support_bounce`)」
  * 「レジスタンス反発 (`resistance_reject`)」
    の 2 パターンのみをコアとする
* 2パターンの関係は AND ではなく OR
  → どちらかを満たせば「反応あり」
* 同一EMAで両パターンが見つかった場合は、**直近（`bars_ago` 最小）を優先**
* ATR は EMA反応には使わず、
  * EMA vs OHLC の位置関係
  * その足＋最大2本先の推移
    のみで判定する
* 検出ウィンドウ: **1h=120本、4h/1d=60本**で統一

